# DRAC in-order

This repo contains the code of the drac in-order (based on Lagarto). It is a core with 5 stages (Fetch-Decode-ReadRegister-Execution-Commit). It is built with educational purposes but with the ASIC in mind. It has some current development and uses the RISCV ISA: 64 bits with M & A extensions and privileged specification.

[develop] status: [![pipeline status](https://repo.hca.bsc.es/gitlab/lagarto/drac-inorder/badges/develop/pipeline.svg)](https://repo.hca.bsc.es/gitlab/lagarto/drac-inorder/commits/develop)

## Project structure

The project structure is the following:

* includes
* docs
* rtl
* tb

It has been decided to have a granularity of stages, so that we have

* control_unit --> It has the control unit
* datapath --> contains all the stages
* interface_dcache --> access to the dcache decoupled from the mem_stage WIP
* interface_icache --> access to the icache decoupled from the fetch

## Drac Top Level Diagram

![drac top level diagram](/rtl/datapath/doc/Drac-top-level-diagram.png)

## Verification

### Tools

For verification it is used:

* Simulator Questasim for verification of modules
* Simulator Verilator for verification of the whole module
* SpyGlass for linting
* Verific as the front-end of yosys
* Yosys is a synthesize-map-route open-source tool
* Verilator is "the fastest Verilog/SystemVerilog simulator", used for building a simulation model of the core

### Set Up

**Questasim:**

Installation files are in the "/home/drac/Downloads/questasim" folder. You can connect using:

```
ssh -X drac@192.168.10.38
```

The password is "dracdrac"

Copy these install files to your local machine and execute "install.linux64" binary. Follow the installation steps. At the end make sure that the command "vsim" is visible in your machine. If not add the "bin" directory of the Questasim installation to your "$PATH" environment variable. An easy way is modifying the ".bashrc" file and adding at the end:

```
export PATH=$PATH:/route/to/questasim/bin
```

It is also necessary to add the next line to your ".bashrc" in order to indicate where questasim should verify the license

```
export LM_LICENSE_FILE="1900@bsc-caos-gw.bsc.es"
```

For the moment Questasim only works within the BSC network. We are working to make it work through the BSC VPN.

**Spyglass:**

There is a script in /scripts directory called runLintSV.sh for running spyglass in the server. This script automatically connects to drac server, sends the files specified as arguments in the command line and runs the linting check. After that, it creates a directory locally with all the reports generated by spyglass. To run the script is necessary to be connected to the BSC VPN.

As an example you can run the script as follows:
First run the following command in a terminal to launch the BSC_VPN. If you are already on the BSC network omit this step

```
sudo ./jvpn.pl
```

Then run the spyglass script in a directory. Notice that the script will generate a directory with the first argument you give

```
./runLintSV.sh includes/necessary_include.sv src/top_file.sv src/other_files.sv
```

After the linting the script would have copied all the reports in new directory "necessary_include/".

In order to run the script without introducing the password every time, you can use key authentication. First, is necessary create a new pair of RSA keys using the following command, and leaving all the options to default (press enter on each step):

```
ssh-keygen -t rsa -b 4096
```

Once you have the keys you must check that your "$HOME/.ssh" directory is only readable/writable/executable by your user. You can change the permissions using:

```
chmod 0700 ~/.ssh
```

After that, you must copy your public key in the drac server:

```
ssh-copy-id -i ~/.ssh/mykey.pub drac@192.168.10.38
```

**Verilator**

Install Verilator using your favourite package manager (or compile it yourself, you can find it in [github](https://github.com/verilator/verilator)). Make sure you have compatible versions of verilator and GCC as seen in the following table:

| Verilator | GCC    |
|-----------|--------|
| 5.010     | 13.1.1 |

If you use a verilator and GCC version combination that works and is not in the table above, please update it.

### Recommendations

* Warnings should be zero or accurately explained why is happening
* Mandatory: one test-bench per module
* Usage of assertions in the code

## Simulations

### Specific test-benches

Inside every test-bench folder there is one script called runtest.sh with this would be enough

### Running all test-benches

There is a make in every folder of tb and one in general, in the future this should be enough for making the regression test.

### Run Lagarto along Drac in simulation

To run both cores along the SoC you need to clone the lagarto-lowrisc repository in a different folder.
Checkout to the branch ```feature/drac-inorder```
Initialize and update git submodules.
Run make ```make vsim/DefaultConfig-sim```

### Running verilator simulations

To build the verilog simulator, run `make $(nproc) sim`. This will create an executable in the root folder named `sim`. To run a program, simply run `./sim +load=<path/to/file>`. To generate the waveforms for a simulation, run with `+vcd`.

The isa tests can be run using `make run-isa-tests`. This command should take care of both the compilation of the simulation and the isa tests.